# Тестовое Задание для Стажера Python-Разработчика: API для Библиотеки

RESTful API для базового управления библиотечным каталогом. Система должна позволять управляет информацией о книгах и читателях, а также процессом выдачи и возврата книг, с использованием JWT для аутентификации пользователей (библиотекарей).


## Локальный запуск

Клонировать репозиторий и установить зависимости:
```sh
git clone https://github.com/h4cktivist/library-api.git
cd library-api
pip install -r requirements.txt
```

Создать `.env` файл в корне проекта и задать параметры подключения к PostgreSQL базе данных согласно шаблону в `.env.example`.

Применить миграции к базе данных:
```sh
alembic upgrade head
```

Запустить веб-сервис:
```sh
uvicorn main:app
```

API будет доступен по адресу *http://127.0.0.1:8000*

Swagger-документация с ручками и структурами запросов доступна по адресу */docs*


## Структура проекта

- `alembic/` - файлы миграций
- `api/v1/` - главная бизнес-логика API: роуты, схемы, CRUD-операции
- `core/` - конфигурации и настройки веб-сервиса
- `db/` - файл подключения к БД и ORM-модели сущностей
- `tests/` - тесты


## Структура базы данных

Структура БД построена согласно описанной в ТЗ. Есть сущности: Пользователь (библиотекарь), Книга, Читатель, Выдача. Сущность Выдача хранит информацию о взятых и возвращенных пользователем книгах, имея в каждой записи два внешних ключа - на Читателя и Книгу.

![{C4448CD9-085C-4FE6-95FF-DCE9DBDF51B7}](https://github.com/user-attachments/assets/ab799fa6-3bc3-41c1-9dd2-530618a3aabc)


## Опиание бизнес-логики

*Аутентификация и авторизация*

  - JWT-токены для библиотекарей
  - Хеширование паролей (bcrypt)
  - Защита всех эндпоинтов (кроме `/auth/login`, `/auth/register` и `/books`)

*Управление книгами*
- CRUD-операции с валидацией:
- Автоматическое уменьшение/увеличение количества при выдаче/возврате

*Управление читателями (Readers)*
- CRUD-операции
- Читатели не имеют паролей (ими управляют библиотекари)

*Выдача и возврат книг (Borrowings)*
Выдача книги:
- Проверка доступности (количество > 0)
- Уменьшение количества книг на 1 при успешной выдаче
- Ограничение: не более 3 книг на читателя
- Фиксация в таблице `borrowings`

Возврат книги:
- Проверка, что книга выдана этому читателю
- Проверка, что книга еще не возвращена
- Увеличение количества книг на 1 при успешном возврате
- Изменение поля `return_date` в таблице `borrowings`


## Аутентификация

- Происходит посредством JWT-токена, получаемого отправкой запроса с логином и паролем на URL `/auth/login`
- Пароли хранятся в БД в захэшированном виде, хэширование и проверка правильности происходят с помощью библиотеки `passlib`
- Генерация токена происходит с помощью библиотеки `jose`, в качестве полезной нагрузки токена задается email библиотекаря
- Защищены все эндпоинты, кроме `/auth/login`, `/auth/register` и `/books`, так как первые два отвечают за регистрацию и авторизацию, а список книг должен быть доступен не только библиотекарям, но и любым пользователям системы (даже не авторизованным)


## Дополнительная фича

*Идея:* Реализовать возможность бронирования книг, которые временно отсутствуют, с уведомлением читателя, когда книга становится доступной.

*Как реализовать:*
- Добавить новую сущность в БД, которая будет хранить брони
- При отсутствии книги для взятия предлагать читателю забронировать ее, создав тем самым запись в таблицу броней (как минимум хранить ID книги, ID пользователя и дату брони)
- При возвращении забронированной книги предложить выдать книгу первому в очереди на бронь (читателю, отправившему бронь позже остальных), отправив уведомление на почту (интегрировать какой-нибудь почтовый сервис)
- Если читатель, забронировавший книгу, откажется от ее взятия, предложить другому читателю в очереди
